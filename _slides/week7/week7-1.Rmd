---
title: "Two Factor Factorial Designs"
author: "Kris Sankaran | UW Madison | 23 September 2021"
output:
  xaringan::moon_reader:
    css: ["default", "css/xaringan-themer.css", "cols.css"]
    lib_dir: libs
    nature:
      beforeInit: "cols_macro.js"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
    seal: false  
---

```{r setup, include=FALSE}
library(knitr)
library(ggplot2)
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = TRUE, dpi = 200, fig.width = 2, fig.height = 1, dev = 'svg', dev.args = list(bg = "transparent"))
theme424 <- theme_minimal() + 
  theme(
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "#f7f7f7"),
    panel.border = element_rect(fill = NA, color = "#0c0c0c", size = 0.6),
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 16),
    legend.position = "bottom"
  )
theme_set(theme424)
```

# Two Factor Factorial Designs

```{r, out.width = 200}
include_graphics("https://uwmadison.box.com/shared/static/a8jqduhcmjzj9re22a81236k3enbtzzn.png")
```
### Statistical Experimental Design

.large[Kris Sankaran | UW Madison | 23 September 2021]

---

### Today

* Book Sections: 5.3
* Online Notes: Week 7 [1] and [2]

---

### Motivation

* Last time we introduced the factorial design setting
* How can we guide decision making around,
  - Whether a factor has a relationship with the response?
  - Whether any interaction effects exist?
* As the number of factors increases, these become harder to check visually
  - Having quantitative summaries / uncertainties is critical

---

### Two-Factor Model

We start by considering only two factors.

\begin{align}
y_{ijk} = \mu + \tau_i + \beta_j + \left(\tau\beta\right)_{ij} + \epsilon_{ij} \\
\epsilon_{ijk} &\sim \mathcal{N}\left(0, \sigma^2\right)
\end{align}

* $i$ indexes the $a$ levels of the first factor (temperature).
* $j$ indexes the $b$ levels of the second factor (material).
* $k$ indexes the $n$ replicates at a particular combination factors.

---

### Interpretation

* $\mu$ is the global mean
* $\tau_i$ is the effect of the $i^{th}$ level of factor 1
* $\beta_{j}$ is the effect of the $j^{th}$ level of factor 2
* $\left(\tau\beta\right)_{ij}$ is the interaction between the $i^{th}$ level of factor 1 and the $j^{th}$ level of factor 2
* $\epsilon_{ijk}$: Random variation between samples a fixed setting of the two
factors

```{r, fig.cap = "A graphical view of all the parameters in a factorial design.", preview = TRUE}
include_graphics("figure/parameters.png")
```

---

### Example Interpretation

Suppose we are studying how battery life depends on temperature and material.

* $\mu$ is average battery lifetime across all settings
* $\tau_i$ encodes how using temperature level $i$ affects battery lifetime
* $\beta_{j}$ encodes how using material $j$ affects battery lifetime
* $\left(\tau\beta\right)_{ij}$ encodes whether there is a synergy between temperature $i$ and material $j$
* $\epsilon_{ijk}$: Random variation in battery lifetime when fixing temperature and material

```{r, fig.cap = "A graphical view of all the parameters in a factorial design.", preview = TRUE}
include_graphics("figure/parameters.png")
```

---

### Testing Main Effects

* We now have multiple factors of interest, and each gets a hypothesis test.
* For each hypothesis test, we will need a different test statistic.

(Hypothesis A) For the first factor, 
\begin{align}
H_0 &: \tau_1 = \dots = \tau_a = 0 \\
H_{1} &: \tau_{i} \neq 0 \text{ for at least one } i
\end{align}

(Hypothesis B) For the second factor,
\begin{align}
H_0 &: \beta_1 = \dots = \beta_{b} = 0 \\
H_{1} &: \beta_{j} \neq 0 \text{ for at least one } j
\end{align}

---

### Interaction Effect

(Hypothesis AB) Are there interaction effects?
\begin{align}
H_0: \left(\tau\beta\right)_{ij}= \dots = \left(\tau\beta\right)_{ij} = 0 \\
H_1: \left(\tau\beta\right)_{ij} &= 0 \text{ for at least one } ij \text{ combination}
\end{align}

---

### ANOVA-like Identity

.pull-left[
* We’ll denote this by $SS_{\text{Total}}=SS_{A}+SS_{B}+SS_{AB}+SS_{E}$
* Dividing terms on the right by their degrees of freedom gives $MS_{A}, MS_{B}, MS_{AB}$, and $MS_{E}$
* *Don't* try memorizing the formulas, but *do* know how to relate the formulas to computer output
]

.pull-right[
\begin{align*}
\sum_{i j k}\left(y_{i j k}-\bar{y}\right)^{2}=& b n \sum_{i}\left(\bar{y}_{i . .}-\bar{y}\right)^{2}+\\
& a n \sum_{j}\left(\bar{y}_{j} .-\bar{y}\right)^{2}+\\
& n \sum_{i, j}\left(\bar{y}_{i j}-\bar{y}_{i .}-\bar{y}_{. j}-\bar{y}\right)^{2}+\\
& \sum_{i, j, k}\left(y_{i j k}-\bar{y}_{i j} .\right)^{2}
\end{align*}
]
  
---

### Test Statistics

* If $MS_{A}$ is large, we have evidence against hypothesis A
* If $MS_{B}$ is large, we have evidence against hypothesis B

```{r, fig.show = "hold", out.width = "45%"}
include_graphics("https://uwmadison.box.com/shared/static/ner7fbntbrdatsi94lk8p7bz469vigcd.png")
include_graphics("https://uwmadison.box.com/shared/static/sf0qeddpcestas9t5c2ubo7rsyz9cnpk.png")
```

---

### Test Statistics

$MS_{AB}$ is large, we have evidence against hypothesis AB.

```{r, fig.show = "hold", out.width = "45%"}
include_graphics("https://uwmadison.box.com/shared/static/2956oz2t0rows6bj3zprb0yssagp7fww.png")
include_graphics("https://uwmadison.box.com/shared/static/y1j6wo96ocp0cr2ourswaklsa6exl8ed.png")
```

---

### Model Checking

.pull-left[
* The model assumptions are analogous to those for ANOVA
  - No unmeasured systematic variation
  - Independence, normality, and equal variance for $\epsilon_{ijk}$
* Like with ANOVA, we can use residuals
\begin{align}
e_{ijk} &= y_{ijk} - \hat{y}_{ijk} \\
&= y_{ijk} - \left(\hat{\mu} + \hat{\tau_i} + \hat{\beta_j}\right)
\end{align}
  to check assumptions
]

.pull-right[
  * Plot residuals against each of the two factors
  * Plot fitted vs. residual value
  * Make QQ plots
]

---

### Contrasts

Like in ANOVA, we may want to use contrasts to compare levels of a factor.

.pull-left[
* _Subtlety_: If the factor under investigation interacts with the other one,
its effects will depend on that other factor.
* _Solution_: Fix a level for the other factor, and study the influence of
levels for the factor of interest.
]

.pull-right[
```{r, fig.margin=TRUE, echo = FALSE, fig.cap = "All pairwise contrasts between levels of one factor, restricted to a single level of another.", fig.width = 2.6}
library("EBImage")
display(readImage("https://uwmadison.box.com/shared/static/oqhdg1jvjwo4x4g5z0y294555xb1nnz3.png"))
```
]

---

### Contrasts Example

.pull-left[
In the battery example, we may want to first fix temperature, and then use
Tukey’s HSD to study pairwise difference between materials (for that fixed
temperature).
]

.pull-right[
```{r, fig.margin=TRUE, echo = FALSE, fig.cap = "All pairwise contrasts between levels of one factor, restricted to a single level of another.", fig.width = 2.6}
library("EBImage")
display(readImage("https://uwmadison.box.com/shared/static/oqhdg1jvjwo4x4g5z0y294555xb1nnz3.png"))
```
]

---

# Code Implementation

---

### Battery Dataset

How do material and temperature affect battery lifetimes? These are the two
factors of interest, and each is measured at 3 levels.

```{r}
options(echo = TRUE)
```


```{r}
library(readr)
library(dplyr)
battery <- read_table2("https://uwmadison.box.com/shared/static/vmxs2wcsdxkdjujp85nw5kvk83xz4gl9.txt") %>%
  mutate_at(vars(-Life), as.factor) # convert columns except "Life" to factor

battery
```

---

### Visualization

The `facet_wrap` and `facet_grid` commands in ggplot2 can be useful for plotting
a variable across combinations of factors.

```{r, fig.height = 3, fig.width = 5}
library(ggplot2)
ggplot(battery) +
  geom_point(aes(Temperature, Life)) +
  facet_wrap(~ Material)
```

---

### Model Fit

* We can fit the two factor model using `lm`.
* The syntax `Material * Temperature` to fits all main effects and interactions
  - It is shorthand for `Material + Temperature + Material : Temperature` (the `:` denotes an interaction)

```{r}
fit <- lm(Life ~ Material * Temperature, data = battery)
summary(aov(fit))
```


---

### Model Fit

* The `Material` and `Temperature` rows of the ANOVA table give main effects
* The `Material:Temperature` row gives the interaction effect
* The `Residuals` row corresponds to the $SS_{E}$ and $MS_{E}$ terms.

```{r}
fit <- lm(Life ~ Material * Temperature, data = battery)
summary(aov(fit))
```

There are strong temperature and material effects, and a slight interaction
effect.

---

### Futher Interpretation

* The `summary` command shows all fitted coefficients
* The first temperature and material coefficients are absorbed into the baseline
* The significant interaction between material 3 and temperature 70 means this
combination lives about 80 units longer than expected in the absence of
interaction

```{r}
summary(fit)
```

---

### Contrasts

We can continue to use `fit.contrast` to test for contrasts, ignoring any
potential interactions.

```{r}
library(gmodels)
fit.contrast(fit, "Temperature", c(1, -1, 0))
```

---

### Contrasts

If we are worried about interactions, we can use the `emmeans` function to
compare pairs of materials within each temperature level.

```{r}
library(emmeans)
emmeans(fit, pairwise ~ Material | Temperature)$contrasts
```

---

### Model Checking

As before, we can use `resid` and `predict` to extract residuals and fitted
values.

```{r, }
battery <- battery %>%
  mutate(resid = resid(fit), y_hat = predict(fit)) # create two new columns
ggplot(battery) +
  geom_point(aes(Temperature, resid))
```

---

# Exercise

---