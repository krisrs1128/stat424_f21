---
title: "Randomized Complete Block Designs"
author: "Kris Sankaran | UW Madison | October 5, 2021"
output:
  xaringan::moon_reader:
    css: ["default", "css/xaringan-themer.css", "cols.css"]
    lib_dir: libs
    nature:
      beforeInit: "cols_macro.js"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
    seal: false  
---

```{r setup, include=FALSE}
library(knitr)
library(ggplot2)
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, dpi = 200, fig.width = 6, fig.height = 2.8, dev = 'svg', dev.args = list(bg = "transparent"))
theme424 <- theme_minimal() + 
  theme(
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "#f7f7f7"),
    panel.border = element_rect(fill = NA, color = "#0c0c0c", size = 0.6),
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 16),
    legend.position = "bottom"
  )
theme_set(theme424)
```

# Randomized Complete Block Designs

```{r, out.width = 300}
include_graphics("https://uwmadison.box.com/shared/static/fgtpgaimnwwlm5s63bmj9f8ahe1nq4qp.png")
```

### Statistical Experimental Design

.large[Kris Sankaran | UW Madison | 5 October 2021]

---

### Today

* Book Sections: 4.1
* Online Notes: Week 5 [1], [2]

---

### Motivation

In real problems, it's often necessary to "block" away nuisance variation.

* How should we adapt ANOVA to settings where blocking is necessary?
* How can we generalize the intuition behind pairing to more than 2 treatment
levels?

---

### Examples

> A medical device manufacturer creates vascular grafts,
and wants to see the effect of manufacturing pressure on defect rate. But the resin
used to make the graft arrives in batches, and may itself contribute to defects.

Other examples,
* Accounting for weekday vs. weekend effects when testing different web designs
* Comparing genetic effects when samples were sequenced on different platforms

---

### Main Idea

.pull-left[
> Randomly assign each of the $a$ treatments to the units within each block. 

* This design is called a Randomized Complete Block Design.
* It generalizes pairing to the case of $K > 2$ treatments.
* Limitation: Need equal number of samples per blocks as there are treatments
]
.pull-right[
```{r, fig.hold = TRUE, out.width = "40%", out.extra='angle=90'}
include_graphics("https://uwmadison.box.com/shared/static/pq0v9wj2z63szngnxqm0mjfiq323q28k.png")
```
]

---

### Main Idea

.pull-left[
> Randomly assign each of the $a$ treatments to the units within each block. 

* This design is called a Randomized Complete Block Design.
* It generalizes pairing to the case of $K > 2$ treatments.
* Limitation: Need equal number of samples per blocks as there are treatments
]

.pull-right[
```{r, fig.hold = TRUE, out.width = "60%", out.extra='angle=90'}
include_graphics("https://uwmadison.box.com/shared/static/35mmpml4az9ztv2wd5zp45mxiun11gja.png")
```
]

---

### Model

.pull-left[
\begin{align}
y_{ij} &= \mu + \tau_i + \beta_{j} + \epsilon_{ij} \\
\epsilon_{ij} &\sim \mathcal{N}\left(0, \sigma^2\right)
\end{align}

As before,
  * $\mu$ is a global mean
  * $\tau_i$ is the treatment effect for the $i^{th}$ treatment level
  * $\epsilon_{ij}$ is the error term
  
But now we also have
  * $\beta_{j}$, the effect of the $j^{th}$ block
]

.pull-right[
```{r, fig.cap = "An example of a dataset generated by the model with block effects."}
include_graphics("https://uwmadison.box.com/shared/static/fgtpgaimnwwlm5s63bmj9f8ahe1nq4qp.png")
```
]

---

### Discussion

Imagine you are working with project team to study the effect of listen to music
(no music, only instrumental, and with vocals) on short math quizzes. Members of
your team have varying test-taking skills. Discuss,

* Why might an RCBD design be appropriate?
* If an RCBD were used, how many quizzes would each person have to take?
* Interpret the greek letters on the previous page within context of this study


---

### Hypothesis Testing

Do any of the treatments have any effect, after controlling for nuisance
variation across blocks?

\begin{align*}
H_0 &: \tau_1 = \dots = \tau_a = 0 \\
H_{1} &: \tau_{i} \neq 0 \text{ for at least one } i
\end{align*}

---

### ANOVA-like Identity

* $\bar{y}_{\cdot\cdot}$ is sample mean across all observations
* $\bar{y}_{i \cdot}$ is the sample mean of treatment $i$ 
* $\bar{y}_{\cdot j}$ is the sample mean of block $j$

Then, it turns out

\begin{align*}
\sum_{i = 1}^{a}\sum_{j = 1}^{b}\left(y_{ij} - \bar{y}_{\cdot\cdot}\right)^2 = &b\sum_{i = 1}^{a} \left(\bar{y}_{i\cdot} - \bar{y}_{\cdot\cdot}\right)^2 + \\
& a \sum_{j = 1}^{b}\left(\bar{y}_{\cdot j} - \bar{y}_{\cdot\cdot}\right)^2 + \\
&\sum_{i = 1}^{a}\sum_{j = 1}^{b} \left(y_{ij} - \bar{y}_{i\cdot} - \bar{y}_{\cdot j} + \bar{y}_{\cdot\cdot}\right)^2
\end{align*}

---

### ANOVA-like Identity

* $\bar{y}_{\cdot\cdot}$ is sample mean across all observations
* $\bar{y}_{i \cdot}$ is the sample mean of treatment $i$ 
* $\bar{y}_{\cdot j}$ is the sample mean of block $j$

This is abbreviated,
\begin{align*}
SS_{\text{Total}} = SS_{\text{Treatment}} + SS_{\text{Block}} + SS_{E}
\end{align*}

---

### Derived Quantities

* $MS_{\text{Total}}= \frac{1}{N - 1}SS_T$, which is the sample variance of all $y_{ij}$
* $MS_{\text{Treatment}}=\frac{1}{a - 1}SS_{\text{Treatment}}$
* $MS_{\text{Block}}=\frac{1}{b - 1}SS_{\text{Block}}$
* $MS_{E}=\frac{1}{(a - 1)(b - 1)}SS_{E}$, which a good estimator for $\sigma^2$

As in ANOVA, if $MS_{\text{Treatment}}$ is much larger than $MS_{E}$, then we
have evidence against the null hypothesis.

---

### Reference Distribution

To test the null hypothesis,
\begin{align*}
H_0 &: \tau_1 = \dots = \tau_a = 0 \\
H_{1} &: \tau_{i} \neq 0 \text{ for at least one } i
\end{align*}

we use the fact that under $H_0$,

\begin{align}
\frac{MS_{\text{Treatment}}}{MS_{E}} \sim F\left(a - 1, \left(a - 1\right)\left(b - 1\right)\right)
\end{align}

---

### Diagnostics

* $\epsilon \sim \mathcal{N}\left(0, \sigma^2\right)$ are independently distributed. (_Same as before_)
* The treatment effects $\tau_i$ are the same across all blocks. (_New_)
  - Often called the "additivity" assumption
---

### Diagnostics

* All the earlier diagnostics continue to apply for checking the first assumption
* To check additivity, plot residuals against their block
  - Consistently positive or negative residuals suggests that the treatment is
  systematically different across blocks

---

### Contrasts and Multiple Comparisons

* All the machinery for contrasts and multiple comparisons can still be used
* The only difference is that we are examining contrasts of group means _after controlling for block effects_
* See below for a code example

---

### Code Implementation

The code below reads in the vascular graft dataset. Is there an effect of
pressure on yield, controlling for possible batch effects?

```{r}
opts_chunk$set(echo = TRUE)
options(width = 300)
```

```{r, echo = TRUE}
library(readr)
library(tidyr)
graft <- read_table2("https://uwmadison.box.com/shared/static/0ciblk4z2f3k6zizbj4plg3q33w1d0n6.txt") %>%
  pivot_longer(-Pressure, names_to = "batch", values_to = "yield")
graft$Pressure <- as.factor(graft$Pressure)
```

---

### Plotting against Batches

* There are systematic differences across batches
* There seem to be differences across pressures as well (e.g., purple points)

```{r}
library(ggplot2)
ggplot(graft) +
  geom_point(aes(x = batch, y = yield, col = Pressure)) +
  scale_color_brewer(palette = "Set2") # custom color scheme
```

---

### RCBD

* We can use the `lm` function to fit the RCBD model. 
* Note that the right hand side includes both the variable of interest
(`Pressure`) and an indicator of the batch from which each sample came
(`batch`).

```{r}
fit <- lm(yield ~ Pressure + batch, graft)
summary(aov(fit))
``` 

Q: Which elements correspond to $MS_{\text{Block}}$, $MS_{\text{Treatment}}$,
and $MS_{E}$?

---

### Interpretation

```{r}
fit <- lm(yield ~ Pressure + batch, graft)
summary(aov(fit))
```

The low $p$-values indicate there is both batch-to-batch variation and a real
pressure effect on yield.

---

### Additivity Assumption

Plotting residuals against batch, we don't see an additivity assumption (Why?).
However, equality of variance across batches seems violated.

```{r}
graft$residual <- resid(fit)
ggplot(graft) +
  geom_point(aes(x = batch, y = residual, col = Pressure)) +
  scale_color_brewer(palette = "Set2")
```

---

### Contrasts

We can test for contrasts using the exact same recipe as before,

* Build a contrast vector / matrix
* Use `fit.contrast` to conduct a hypothesis test

This will be true almost without exception for the remainder of the class.

```{r}
contrasts <- matrix( c(1, 1, -1, -1, 1, 0, 0, -1), nrow = 2, byrow=TRUE )
fit.contrast(aov_table, "Pressure", contrasts)
```

---

### Multiple Comparisons

* If we are search across many contrasts, we should control for multiple comparisons
* The same functions can be applied

This will be true almost without exception for the remainder of the class.

```{r}
PostHocTest(aov_table, method = "scheffe", contrasts = contrasts)
```

---

### Multiple Comparisons

* If we are search across many contrasts, we should control for multiple comparisons
* The same functions can be applied

This will be true almost without exception for the remainder of the class.

```{r}
TukeyHSD(aov_table)$Pressure # can also look batch-to-batch differences
```

---

### Exercise

---
exclude: true

LO's
- Fit an RCBD using either fixed or random treatments
- Recognize when to fit an RCBD
- Interpret RCBD computer output
- Recognize when to apply an RCBD with random batch effects
- Discuss model fit / appropriateness of assumptions using diagnostics