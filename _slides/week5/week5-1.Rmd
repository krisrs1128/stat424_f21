---
title: "Randomized Complete Block Designs"
author: "Kris Sankaran | UW Madison | October 5, 2021"
output:
  xaringan::moon_reader:
    css: ["default", "css/xaringan-themer.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
    seal: false  
---

```{r setup, include=FALSE}
library(knitr)
library(ggplot2)
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE, dpi = 200, fig.width = 6, fig.height = 2.8, dev = 'svg', dev.args = list(bg = "transparent"), fig.align = "center")
theme424 <- theme_minimal() + 
  theme(
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "#f7f7f7"),
    panel.border = element_rect(fill = NA, color = "#0c0c0c", size = 0.6),
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 16),
    legend.position = "bottom"
  )
theme_set(theme424)
```

# Randomized Complete Block Designs

```{r, out.width = 300, fig.align = "left"}
include_graphics("https://uwmadison.box.com/shared/static/fgtpgaimnwwlm5s63bmj9f8ahe1nq4qp.png")
```

### Statistical Experimental Design

.large[Kris Sankaran | UW Madison | 5 October 2021]

---

### Today

* Book Sections: 4.1
* Online Notes: Week 5 [1], [2]

---

### Motivation

In real problems, it's often necessary to "block" away nuisance variation.

* How should we adapt ANOVA to settings where blocking is necessary?
* How can we generalize the intuition behind pairing to more than 2 treatment
levels?

---

### Examples

> A medical device manufacturer creates vascular grafts,
and wants to see the effect of manufacturing pressure on defect rate. But the resin
used to make the graft arrives in batches, and may itself contribute to defects.

Other examples,
* Accounting for weekday vs. weekend effects when testing different web designs
* Comparing genetic effects when samples were sequenced on different platforms

---

### Main Idea

.pull-left[
> Randomly assign each of the $a$ treatments to the units within each block. 

* This design is called a Randomized Complete Block Design.
* It generalizes pairing to the case of $K > 2$ treatments.
* Limitation: Need equal number of samples per blocks as there are treatments.
]
.pull-right[
```{r, fig.hold = TRUE, out.width = "40%", out.extra='angle=90'}
include_graphics("https://uwmadison.box.com/shared/static/pq0v9wj2z63szngnxqm0mjfiq323q28k.png")
```
]

---

### Main Idea

.pull-left[
> Randomly assign each of the $a$ treatments to the units within each block. 

* This design is called a Randomized Complete Block Design.
* It generalizes pairing to the case of $K > 2$ treatments.
* Limitation: Need equal number of samples per blocks as there are treatments.
]

.pull-right[
```{r, fig.hold = TRUE, out.width = "60%", out.extra='angle=90'}
include_graphics("https://uwmadison.box.com/shared/static/35mmpml4az9ztv2wd5zp45mxiun11gja.png")
```
]

---

### Model

.pull-left[
\begin{align}
y_{ij} &= \mu + \tau_i + \beta_{j} + \epsilon_{ij} \\
\epsilon_{ij} &\sim \mathcal{N}\left(0, \sigma^2\right)
\end{align}

As before,
  * $\mu$ is a global mean
  * $\tau_i$ is the treatment effect for the $i^{th}$ treatment level
  * $\epsilon_{ij}$ is the error term
  
But now we also have
  * $\beta_{j}$ the effect of the $j^{th}$ block
]

.pull-right[
```{r, fig.cap = "An example of a dataset generated by the model with block effects."}
include_graphics("https://uwmadison.box.com/shared/static/fgtpgaimnwwlm5s63bmj9f8ahe1nq4qp.png")
```
]

---

### Discussion

Imagine you are working with project team to study the effect of listening to
music (no music, only instrumental, and with vocals) on short math quizzes.
Members of your team have varying test-taking skills. Discuss,

* Why might an RCBD be appropriate?
* If an RCBD were used, how many quizzes would each person have to take?
* Interpret the greek letters on the previous page within context of this study


---

### Hypothesis Testing

Do any of the treatments have any effect, after controlling for nuisance
variation across blocks?

\begin{align*}
H_0 &: \tau_1 = \dots = \tau_a = 0 \\
H_{1} &: \tau_{i} \neq 0 \text{ for at least one } i
\end{align*}

---

### ANOVA-like Identity

* $\bar{y}_{\cdot\cdot}$ is sample mean across all observations
* $\bar{y}_{i \cdot}$ is the sample mean of treatment $i$ 
* $\bar{y}_{\cdot j}$ is the sample mean of block $j$

Then, it turns out

\begin{align*}
\sum_{i = 1}^{a}\sum_{j = 1}^{b}\left(y_{ij} - \bar{y}_{\cdot\cdot}\right)^2 = &b\sum_{i = 1}^{a} \left(\bar{y}_{i\cdot} - \bar{y}_{\cdot\cdot}\right)^2 + \\
& a \sum_{j = 1}^{b}\left(\bar{y}_{\cdot j} - \bar{y}_{\cdot\cdot}\right)^2 + \\
&\sum_{i = 1}^{a}\sum_{j = 1}^{b} \left(y_{ij} - \bar{y}_{i\cdot} - \bar{y}_{\cdot j} + \bar{y}_{\cdot\cdot}\right)^2
\end{align*}

---

### ANOVA-like Identity

* $\bar{y}_{\cdot\cdot}$ is sample mean across all observations
* $\bar{y}_{i \cdot}$ is the sample mean of treatment $i$ 
* $\bar{y}_{\cdot j}$ is the sample mean of block $j$

This is abbreviated,
\begin{align*}
SS_{\text{Total}} = SS_{\text{Treatment}} + SS_{\text{Block}} + SS_{E}
\end{align*}

---

### Derived Quantities

* $MS_{\text{Total}}= \frac{1}{N - 1}SS_{\text{Total}}$, which is the sample variance of all $y_{ij}$
* $MS_{\text{Treatment}}=\frac{1}{a - 1}SS_{\text{Treatment}}$
* $MS_{\text{Block}}=\frac{1}{b - 1}SS_{\text{Block}}$
* $MS_{E}=\frac{1}{(a - 1)(b - 1)}SS_{E}$, which a good estimator for $\sigma^2$

As in ANOVA, if $MS_{\text{Treatment}}$ is much larger than $MS_{E}$, then we
have evidence against the null hypothesis.

---

### Reference Distribution

To test the null hypothesis,
\begin{align*}
H_0 &: \tau_1 = \dots = \tau_a = 0 \\
H_{1} &: \tau_{i} \neq 0 \text{ for at least one } i
\end{align*}

we use the fact that under $H_0$,

\begin{align}
\frac{MS_{\text{Treatment}}}{MS_{E}} \sim F\left(a - 1, \left(a - 1\right)\left(b - 1\right)\right)
\end{align}

---

### Diagnostics

* $\epsilon \sim \mathcal{N}\left(0, \sigma^2\right)$ are independently distributed. (_Same as before_)
* The treatment effects $\tau_i$ are the same across all blocks. (_New_)
  - Often called the "additivity" assumption
  
```{r out.width = 300}
include_graphics("https://uwmadison.box.com/shared/static/dmob9sjh8my7l8hez390o7gnn3vu1oe6.png")
```
  
---

### Diagnostics

* All the earlier diagnostics continue to apply for checking the first assumption
* To check additivity, plot residuals against their block
  - Consistently positive or negative residuals suggests that the treatment is
  systematically different across blocks

---

### Contrasts and Multiple Comparisons

* All the machinery for contrasts and multiple comparisons can still be used
* The only difference is that we are examining contrasts of group means _after controlling for block effects_
* See below for a code example

```{r, out.width = 400}
include_graphics("https://uwmadison.box.com/shared/static/qezu75a0hv1qhqyeoz8wb7sbb294vrsm.png")
```

---

# Code Implementation

Take out your laptops!

---

### Learning new Functions

Whenever we encounter an unfamiliar function, we need to figure out what exactly
the inputs and outputs are. A few functions can help with this -- try using
these throughout the examples below.

* `?f` or `help(f)`: Pulls up the documentation about function `f`. Ideally this
species the format of the input and output.
* `example(f)`: Provides examples of the use of `f` from the documentation.
* `str(object)`: Prints out the type and structure of an object. Especially useful to apply to the inputs and

---

### Dataset

The code below reads in the vascular graft dataset. Is there an effect of
pressure on yield, controlling for possible batch effects?

```{r}
opts_chunk$set(echo = TRUE)
options(width = 300)
```

```{r, echo = TRUE}
library(readr)
library(tidyr)
graft <- read_table2("https://uwmadison.box.com/shared/static/0ciblk4z2f3k6zizbj4plg3q33w1d0n6.txt") %>%
  pivot_longer(-Pressure, names_to = "batch", values_to = "yield")
graft$Pressure <- as.factor(graft$Pressure)
```

---

### Example `str`

```{r}
str(graft)
```

---

### Plotting against Batches

* There are systematic differences across batches
* There seem to be differences across pressures as well (e.g., purple points)

```{r}
library(ggplot2)
ggplot(graft) +
  geom_point(aes(x = batch, y = yield, col = Pressure)) +
  scale_color_brewer(palette = "Set2") # custom color scheme
```

---

### RCBD

* We can use the `lm` function to fit the RCBD model. 
* Note that the right hand side includes both the variable of interest
(`Pressure`) and an indicator of the batch from which each sample came
(`batch`).

```{r}
fit <- lm(yield ~ Pressure + batch, graft)
aov_table <- aov(fit)
summary(aov_table)
``` 

Q: Which elements correspond to $MS_{\text{Block}}$, $MS_{\text{Treatment}}$,
and $MS_{E}$?

---

### Interpretation

```{r}
fit <- lm(yield ~ Pressure + batch, graft)
aov_table <- aov(fit)
summary(aov_table)
```

The low $p$-values indicate there is both batch-to-batch variation and a real
pressure effect on yield.

---
### Additivity Assumption

Plotting residuals against batch, we don't see an additivity assumption (Why?).
However, equality of variance across batches seems violated.

```{r}
graft$residual <- resid(fit)
ggplot(graft) +
  geom_point(aes(x = batch, y = residual, col = Pressure)) +
  scale_color_brewer(palette = "Set2")
```

---

### Contrasts

We can test for contrasts using the exact same recipe as before,

* Build a contrast vector / matrix
* Use `fit.contrast` to conduct a hypothesis test

This will be true almost without exception for the remainder of the class.

```{r}
library(gmodels)
contrasts <- matrix( c(1, 1, -1, -1, 1, 0, 0, -1), nrow = 2, byrow=TRUE )
fit.contrast(fit, "Pressure", contrasts)
```

---

### Example Documentation

```{r}
?fit.contrast
example(fit.contrast)
```

---

### Multiple Comparisons

* If we are search across many contrasts, we should control for multiple comparisons
* The same functions can be applied

This will be true almost without exception for the remainder of the class.

```{r}
library(DescTools)
PostHocTest(aov_table, method = "scheffe", contrasts = contrasts)$Pressure
```

---

### Multiple Comparisons

* If we are search across many contrasts, we should control for multiple comparisons
* The same functions can be applied

This will be true almost without exception for the remainder of the class.

```{r}
TukeyHSD(aov_table)$Pressure # can also look batch-to-batch differences
```

---
class: small

### Exercise

This walks through Problem 4.7 in the textbook.

.pull-left[
> A chemist wishes to test the effect of four chemical agents on the strength of
a particular type of cloth. Because there might be variability from one bolt to
another, the chemist decides to use a randomized block design, with the bolts of
cloth considered as blocks. She selects five bolts and applies all four
chemicals in random order to each bolt. The resulting tensile strengths follow.
Analyze the data from this experiment (use $\alpha = 0.05$) and draw appropriate
conclusions.
]

.pull-right[
```{r}
experiment <- data.frame(
  chemical = c("1", "2", "3", "4"),
  "b1" = c(73, 73, 75, 73),
  "b2" = c(68, 67, 68, 71),
  "b3" = c(74, 75, 78, 75),
  "b4" = c(71, 72, 73, 75),
  "b5" = c(67, 70, 68, 69)
)
```
]

---

(1) Interpret the $\tau_i$ and $\beta_j$ terms of the RCBD model within this
problem context. What corresponds to bolt-to-bolt variation, and what is the
chemical effect?

(2) Use `pivot_longer` from the `tidyr` package to reshape the data so that all
strength values are in a single column.

(3) Determine a formula for `lm` that will fit the chemical effect and control
for bolt-to-bolt variation.

(4) Based on the formula in (4), use `lm` and `aov` to compute a $p$-value for
the chemical effect.

Bonus: What would the $p$-value be if we failed to account for bolt-to-bolt
variation?

---

### Solution (1)

$\tau_1, \dots, \tau_4$ represent the effect of the four chemicals on fabric
strength, relative to the baseline. $\beta_1, \dots, \beta_5$ represent
variation in fabric strength across the five bolts (if there were no
bolt-to-bolt variation, then all the $\beta$'s would be 0).

---

### Solution (2)

This reshaping is exactly the same as in the ANOVA examples. We make sure to
provide names `bolt` and `strength` in the resulting `data.frame`, to make it
easy to remember what each value stands for.
```{r}
library(tidyr)
experiment_long <- experiment %>%
  pivot_longer(-chemical, names_to = "bolt", values_to = "strength")
```

---

### Solution (3)

The formula we need is `strength ~ chemical + bolt`.

* `strength` is the outcome variable of interest
* `chemical` encodes the four different treatments, whose effects we want to evaluate
* `bolt` encodes the five different bolts (the block effects), which we need to control for

---

### Solution (4)

The `lm + aov` pattern is identical to the pattern for ANOVA. The only
difference is the formula, which includes a block effect.

```{r}
fit <- lm(strength ~ chemical + bolt, data = experiment_long)
summary(aov(fit))
```

Apparently, there is no detectable variation across the chemicals at the $\alpha = 0.05$ level.

---

### Bonus

To study the effects without accounting for block effects, we remove the `bolt`
term from the formula. In this case, neither model yields a significant chemical
effect. Often, however, the model accounting for nuisance variation will have
more noticeable effects.

```{r}
fit <- lm(strength ~ chemical, data = experiment_long)
summary(aov(fit))
```
