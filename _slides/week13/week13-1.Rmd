---
title: "Blocking and Mixtures in Response Surface Design"
author: "Kris Sankaran | UW Madison | 23 September 2021"
output:
  xaringan::moon_reader:
    css: ["default", "css/xaringan-themer.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
    seal: false  
---

```{r setup, include=FALSE}
library(knitr)
library(ggplot2)
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = TRUE, dpi = 200, fig.width = 6, fig.height = 2.8, dev = 'svg', dev.args = list(bg = "transparent"))
theme424 <- theme_minimal() + 
  theme(
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "#f7f7f7"),
    panel.border = element_rect(fill = NA, color = "#0c0c0c", size = 0.6),
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 16),
    legend.position = "bottom"
  )
theme_set(theme424)
```

# Blocking and Mixtures in Response Surface Design

```{r, out.width = 200}
include_graphics("https://uwmadison.box.com/shared/static/a8jqduhcmjzj9re22a81236k3enbtzzn.png")
```
### Statistical Experimental Design

.large[Kris Sankaran | UW Madison ]

---

### Today

* Book Sections: 11.4, 11.6
* Online Notes: Week 13 [1] and [3] (skip [2])

---

### Motivation

* At each step in a response surface design, we may encounter nuisance variation
* While sampling for a first-order model, 
  - The operators may change
  - A batch of material might be exhausted
  - Might switch from weekend to weekday in an online shop
* How can we adapt our earlier intuition about blocking to the response surface

---

### Toy Problem: Two Factors

.pull-left[
* Imagine running a central composite design with center points
* There are 14 (= 4 factorial + 4 axial + 6 central) samples to collect, but any
one operator can only collect 7 at a time
* How should we distribute the sampling points across blocks?
  - What would be a bad way to split the points?
]

.pull-right[
```{r}
include_graphics("https://krisrs1128.github.io/stat424_f21/posts/2021-08-17-week12-4/week12-4_files/figure-html5/unnamed-chunk-5-1.png")
```
]

---

### Intuition: Two Factors

* The main idea is to tie blocks together at the center points. 
* Since the runs at central points should be the same (on average), any
systematic difference is an unwanted block effect
* Remaining points are distributed to axial and factorial points
   - This ensures each block is evenly spread across low and high settings
* This intuition works even with larger $K$

.pull-right[
```{r, fig.cap = "By tying sampling center points in both the axial and factorial blocks, it becomes possible to estimate and correct for block effects."}
display(readImage("https://uwmadison.box.com/shared/static/hxsz37wvxcj93osymlckvep6da6ipoqy.png"))
```
]

---

###  More than Two Blocks

* Note that we have limited ourselves to the two-block case
* In general, we follow the same approach as blocking fractional factorial
designs, but with center points tied together
  - Higher order interactions become confounded with the block ID
  - The associated assignments tend to be distributed across the cube
  - The axial points all belong to one block
* See the code example

---

# Code Implementation

---

### Blocking a Design

The default for `ccd` blocks the axial and factorial points.

.pull-left[
```{r}
library(rsm)

codings <- list(time_coded ~ (time - 35) / 5, temp_coded ~ (temp - 150) / 5)
ccd_design <- ccd(~ time_coded + temp_coded, coding = codings)
```
]

.pull-right[
```{r}
head(ccd_design)
```
]

---

### Visualization

Note that we recovered the original temperature and time units using the
`decode.data` function.

.pull-left[
```{r, echo = FALSE, fig.cap = "A central composite design with factor combinations shaded in by the batch from which them emerged."}
ggplot(decode.data(ccd_design)) +
  geom_jitter(aes(time, temp, col = Block)) +
  scale_color_brewer(palette = "Set2") +
  coord_fixed()
```
]

---

### More than 2 Blocks

.pull-left[
* The `blocks` argument to `ccd` allows us to define generators to use during
block construction.
* The generators here are (ABC, CDE). This creates 5 blocks.
  - Four blocks of $2^{5 - 2}$ samples, each of which is a fractional factorial
  - One block of axial points
]

.pull-right[
```{r}
codings <- list(time_ ~ (time - 35) / 5, temp_ ~ (temp - 150) / 5, 
                power_ ~ power, rate_ ~ rate, cooling_ ~ cooling)
blocked_ccd <- ccd(
  ~ time_ + temp_ + power_ + rate_ + cooling_, 
  coding = codings, 
  blocks = Block ~ c(time_ * temp_ * power_, power_ * rate_ * cooling_)
)
```
]

---

```{r, out.width = 700}
ggplot(decode.data(blocked_ccd)) +
  geom_jitter(aes(time, temp, col = Block)) +
  scale_color_brewer(palette = "Set2") +
  coord_fixed()
```

---

# Mixture Experiments

---

### Motivation

* In many problems, we want to find an optimal mixture of ingredients
  - What proportion of the synthetic material should come from different
  sources?
  - How much of the computational budget should be allocated to different
  hyperparameter searches?
* Mixture experiments have a specific geometry which is not respected by the
response surfaces covered so far
  - All the parts have to sum up to 1

---

### Simplex Geometry


---

### Designs on the Simplex

---

### Simplex Lattice Design

---

### Simplex Centroid Design

---

### Fitting Surfaces

---

### Code Implementation

---

### Dataset

---

###

---

###


---

### Exercise

---